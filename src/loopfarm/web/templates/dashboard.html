{% extends "base.html" %}
{% set active_nav = "dashboard" %}

{% block title %}loopfarm - dashboard{% endblock %}

{% block content %}
<div class="dashboard-shell">
  <section class="dashboard-hero">
    <div>
      <h1 class="dashboard-title">Execution Dashboard</h1>
      <p class="dashboard-subtitle">Track root workflows, identify blockers, and jump directly into DAG editing.</p>
    </div>
  </section>

  <section class="metrics-grid" aria-label="Issue metrics">
    <article class="metric-card">
      <p class="metric-label">total issues</p>
      <p class="metric-value">{{ total_issues }}</p>
    </article>
    <article class="metric-card">
      <p class="metric-label">open</p>
      <p class="metric-value">{{ open_count }}</p>
    </article>
    <article class="metric-card">
      <p class="metric-label">ready</p>
      <p class="metric-value">{{ ready_count }}</p>
    </article>
    <article class="metric-card{% if failed_count > 0 %} is-danger{% endif %}">
      <p class="metric-label">failed</p>
      <p class="metric-value">{{ failed_count }}</p>
    </article>
  </section>

  <section class="roots-panel">
    <header class="roots-panel-header">
      <h2>Root Issues</h2>
      <span class="roots-count">{{ roots|length }}</span>
    </header>

    {% if roots %}
      <div class="roots-list">
        {% for rs in roots %}
          <a href="/dag/{{ rs.issue.id }}" class="root-card">
            <div class="root-card-header">
              {% if rs.issue.status == "closed" %}
                {% if rs.issue.outcome == "failure" %}
                  <span class="issue-state-badge is-failure">x</span>
                {% elif rs.issue.outcome == "expanded" %}
                  <span class="issue-state-badge is-expanded">o</span>
                {% elif rs.issue.outcome == "skipped" %}
                  <span class="issue-state-badge is-skipped">-</span>
                {% else %}
                  <span class="issue-state-badge is-success">check</span>
                {% endif %}
              {% else %}
                <span class="issue-state-badge is-open">active</span>
              {% endif %}
              <span class="root-card-title">{{ rs.issue.title[:100] }}</span>
              <span class="root-card-id">{{ rs.issue.id[:16] }}</span>
            </div>
            <div class="root-card-progress-row">
              <div class="root-progress" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="{{ rs.pct }}">
                <div class="root-progress-fill{% if rs.failed > 0 %} is-failure{% elif rs.pct == 100 %} is-success{% endif %}" style="width:{{ rs.pct }}%"></div>
              </div>
              <span class="root-progress-count">{{ rs.closed }}/{{ rs.total }}</span>
              {% if rs.failed > 0 %}
                <span class="root-progress-failed">{{ rs.failed }} failed</span>
              {% endif %}
            </div>
          </a>
        {% endfor %}
      </div>
    {% else %}
      <p class="dashboard-empty">No roots yet. Run <code>loopfarm run "your prompt"</code> to create one.</p>
    {% endif %}
  </section>
</div>
{% endblock %}
